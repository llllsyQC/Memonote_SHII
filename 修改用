Sub å‹¤å‹™æ™‚é–“_æ®‹æ¥­_ç¨¼åƒç‡_å–è¾¼()

    Dim å¹´ As String, æœˆ As String, yyyymm As String
    å¹´ = Trim(Sheets("éƒ½åº¦å¯¾å¿œé …ç›®(æ™‚é–“)").Range("I6").Value)
    æœˆ = Trim(Sheets("éƒ½åº¦å¯¾å¿œé …ç›®(æ™‚é–“)").Range("I7").Value)
    yyyymm = å¹´ & æœˆ

    Dim wbShift As Workbook, wbZangyo As Workbook
    Dim wsTarget As Worksheet
    Dim cell As Range
    Dim ç·å‹¤å‹™æ™‚é–“ As Double, åˆè¨ˆå·¥æ•° As Double, ç¨¼åƒç‡ As Double
    Dim msgText As String

    Set wsTarget = ThisWorkbook.Sheets("éƒ½åº¦å¯¾å¿œé …ç›®(æ™‚é–“)")

    ' ==== å‹¤å‹™å‰²è¡¨ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠ ====
    Dim filePathShift As String
    filePathShift = Application.GetOpenFilename("Excelãƒ•ã‚¡ã‚¤ãƒ« (*.xlsm), *.xlsm", , "ã€å¤§å®®ã€‘å‹¤å‹™å‰²è¡¨ã‚’é¸æŠã—ã¦ãã ã•ã„")

    If filePathShift = "False" Then
        MsgBox "å‹¤å‹™å‰²è¡¨ãŒé¸æŠã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚", vbExclamation
        Exit Sub
    End If

        Set wbShift = Workbooks.Open(filePathShift)
    Dim rowNum As Long, colNum As Long
    Dim lastCol As Long
    Dim found As Boolean

    With wbShift.Sheets(1)
        lastCol = .Cells(1, .Columns.Count).End(xlToLeft).Column
        For rowNum = 1 To .Cells(.Rows.Count, 1).End(xlUp).Row
            For colNum = 1 To lastCol
                If .Cells(rowNum, colNum).Value = "ç·å‹¤å‹™æ™‚é–“" Then
                    ' ä»å½“å‰åˆ—å¼€å§‹å‘å³æ‰¾æ—¶é—´å€¼
                    For i = colNum + 1 To lastCol
                        If IsDate(.Cells(rowNum, i).Value) Then
                            wsTarget.Range("H10").NumberFormat = "h:mm"
                            wsTarget.Range("H10").Value = .Cells(rowNum, i).Value
                            Exit For
                        End If
                    Next i
                ElseIf .Cells(rowNum, colNum).Value = "ç·å¹³æ—¥æ—¥å‹¤æ™‚é–“" Then
                    For i = colNum + 1 To lastCol
                        If IsDate(.Cells(rowNum, i).Value) Then
                            wsTarget.Range("H18").NumberFormat = "h:mm"
                            wsTarget.Range("H18").Value = .Cells(rowNum, i).Value
                            Exit For
                        End If
                    Next i
                End If
            Next colNum
        Next rowNum
    End With
    wbShift.Close False


    ' ==== æ®‹æ¥­æ™‚é–“è¡¨ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠ ====
    Dim filePathZan As String
    filePathZan = Application.GetOpenFilename("Excelãƒ•ã‚¡ã‚¤ãƒ« (*.xlsx), *.xlsx", , "æ®‹æ¥­æ™‚é–“ç®¡ç†è¡¨ã‚’é¸æŠã—ã¦ãã ã•ã„")

    If filePathZan = "False" Then
        MsgBox "æ®‹æ¥­æ™‚é–“ç®¡ç†è¡¨ãŒé¸æŠã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚", vbExclamation
        Exit Sub
    End If

    Set wbZangyo = Workbooks.Open(filePathZan)
    With wbZangyo.Sheets(1)
        wsTarget.Range("H14").NumberFormat = "h:mm"
        wsTarget.Range("H14").Value = .Range("AL4").Value

        wsTarget.Range("H22").NumberFormat = "h:mm"
        wsTarget.Range("H22").Value = .Range("AO4").Value
    End With
    wbZangyo.Close False

    ' ==== ç¨¼åƒç‡è¨ˆç®— ====
    åˆè¨ˆå·¥æ•° = GetMinutes(Application.WorksheetFunction.Sum(wsTarget.Range("EP11:EP64")))
    ç·å‹¤å‹™æ™‚é–“ = GetMinutes(wsTarget.Range("H10").Value)

    If ç·å‹¤å‹™æ™‚é–“ > 0 Then
        ç¨¼åƒç‡ = åˆè¨ˆå·¥æ•° / ç·å‹¤å‹™æ™‚é–“
    Else
        ç¨¼åƒç‡ = 0
    End If

    msgText = "ğŸ“Š ç¨¼åƒç‡ = " & Format(ç¨¼åƒç‡, "0.0%") & vbCrLf & _
              "ãƒ»å·¥æ•°åˆè¨ˆï¼ˆEP11:EP64ï¼‰: " & Format(åˆè¨ˆå·¥æ•° / 60, "0.0") & " æ™‚é–“" & vbCrLf & _
              "ãƒ»ç·å‹¤å‹™æ™‚é–“ï¼ˆH10ï¼‰: " & Format(ç·å‹¤å‹™æ™‚é–“ / 60, "0.0") & " æ™‚é–“"

    MsgBox msgText, vbInformation, "âœ… ç¨¼åƒç‡ç¢ºèªå®Œäº†"

End Sub

Function GetMinutes(timeVal As Variant) As Double
    If IsDate(timeVal) Then
        GetMinutes = CDbl(timeVal) * 24 * 60
    Else
        GetMinutes = 0
    End If
End Function
