Sub 勤務時間_残業_稼働率_取込()

    Dim 年 As String, 月 As String, yyyymm As String
    年 = Trim(Sheets("都度対応項目(時間)").Range("I6").Value)
    月 = Trim(Sheets("都度対応項目(時間)").Range("I7").Value)
    yyyymm = 年 & 月

    Dim wbShift As Workbook, wbZangyo As Workbook
    Dim wsTarget As Worksheet
    Dim cell As Range
    Dim 総勤務時間 As Double, 合計工数 As Double, 稼働率 As Double
    Dim msgText As String

    Set wsTarget = ThisWorkbook.Sheets("都度対応項目(時間)")

    ' ==== 勤務割表をユーザーが選択 ====
    Dim filePathShift As String
    filePathShift = Application.GetOpenFilename("Excelファイル (*.xlsm), *.xlsm", , "【大宮】勤務割表を選択してください")

    If filePathShift = "False" Then
        MsgBox "勤務割表が選択されませんでした。", vbExclamation
        Exit Sub
    End If

    Set wbShift = Workbooks.Open(filePathShift)
    For Each cell In wbShift.Sheets(1).UsedRange
        If cell.Value = "総勤務時間" Then
            wsTarget.Range("H10").NumberFormat = "h:mm"
            wsTarget.Range("H10").Value = cell.Offset(0, 1).Value
        End If
        If cell.Value = "総平日日勤時間" Then
            wsTarget.Range("H18").NumberFormat = "h:mm"
            wsTarget.Range("H18").Value = cell.Offset(0, 1).Value
        End If
    Next
    wbShift.Close False

    ' ==== 残業時間表をユーザーが選択 ====
    Dim filePathZan As String
    filePathZan = Application.GetOpenFilename("Excelファイル (*.xlsx), *.xlsx", , "残業時間管理表を選択してください")

    If filePathZan = "False" Then
        MsgBox "残業時間管理表が選択されませんでした。", vbExclamation
        Exit Sub
    End If

    Set wbZangyo = Workbooks.Open(filePathZan)
    With wbZangyo.Sheets(1)
        wsTarget.Range("H14").NumberFormat = "h:mm"
        wsTarget.Range("H14").Value = .Range("AL4").Value

        wsTarget.Range("H22").NumberFormat = "h:mm"
        wsTarget.Range("H22").Value = .Range("AO4").Value
    End With
    wbZangyo.Close False

    ' ==== 稼働率計算 ====
    合計工数 = GetMinutes(Application.WorksheetFunction.Sum(wsTarget.Range("EP11:EP64")))
    総勤務時間 = GetMinutes(wsTarget.Range("H10").Value)

    If 総勤務時間 > 0 Then
        稼働率 = 合計工数 / 総勤務時間
    Else
        稼働率 = 0
    End If

    msgText = "📊 稼働率 = " & Format(稼働率, "0.0%") & vbCrLf & _
              "・工数合計（EP11:EP64）: " & Format(合計工数 / 60, "0.0") & " 時間" & vbCrLf & _
              "・総勤務時間（H10）: " & Format(総勤務時間 / 60, "0.0") & " 時間"

    MsgBox msgText, vbInformation, "✅ 稼働率確認完了"

End Sub

Function GetMinutes(timeVal As Variant) As Double
    If IsDate(timeVal) Then
        GetMinutes = CDbl(timeVal) * 24 * 60
    Else
        GetMinutes = 0
    End If
End Function
