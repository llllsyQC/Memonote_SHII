Sub å‹¤å‹™æ™‚é–“_æ®‹æ¥­_ç¨¼åƒç‡_å–è¾¼()

    Dim å¹´ As String, æœˆ As String, yyyymm As String
    å¹´ = Trim(Sheets("éƒ½åº¦å¯¾å¿œé …ç›®(æ™‚é–“)").Range("I6").Value)
    æœˆ = Trim(Sheets("éƒ½åº¦å¯¾å¿œé …ç›®(æ™‚é–“)").Range("I7").Value)
    yyyymm = å¹´ & æœˆ

    Dim wbShift As Workbook, wbZangyo As Workbook
    Dim wsTarget As Worksheet
    Dim cell As Range
    Dim ç·å‹¤å‹™æ™‚é–“ As Double, åˆè¨ˆå·¥æ•° As Double, ç¨¼åƒç‡ As Double
    Dim msgText As String

    Set wsTarget = ThisWorkbook.Sheets("éƒ½åº¦å¯¾å¿œé …ç›®(æ™‚é–“)")

    ' ==== å‹¤å‹™å‰²è¡¨ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠ ====
    Dim filePathShift As String
    filePathShift = Application.GetOpenFilename("Excelãƒ•ã‚¡ã‚¤ãƒ« (*.xlsm), *.xlsm", , "ã€å¤§å®®ã€‘å‹¤å‹™å‰²è¡¨ã‚’é¸æŠã—ã¦ãã ã•ã„")

    If filePathShift = "False" Then
        MsgBox "å‹¤å‹™å‰²è¡¨ãŒé¸æŠã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚", vbExclamation
        Exit Sub
    End If

        Set wbShift = Workbooks.Open(filePathShift)
    Dim rowNum As Long, colNum As Long
    Dim lastCol As Long
    Dim found As Boolean

    With wbShift.Sheets(1)
        lastCol = .Cells(1, .Columns.Count).End(xlToLeft).Column
        For rowNum = 1 To .Cells(.Rows.Count, 1).End(xlUp).Row
            For colNum = 1 To lastCol
                If .Cells(rowNum, colNum).Value = "ç·å‹¤å‹™æ™‚é–“" Then
                    ' ä»å½“å‰åˆ—å¼€å§‹å‘å³æ‰¾æ—¶é—´å€¼
                    For i = colNum + 1 To lastCol
                        If IsDate(.Cells(rowNum, i).Value) Then
                            wsTarget.Range("H10").NumberFormat = "h:mm"
                            wsTarget.Range("H10").Value = .Cells(rowNum, i).Value
                            Exit For
                        End If
                    Next i
                ElseIf .Cells(rowNum, colNum).Value = "ç·å¹³æ—¥æ—¥å‹¤æ™‚é–“" Then
                    For i = colNum + 1 To lastCol
                        If IsDate(.Cells(rowNum, i).Value) Then
                            wsTarget.Range("H18").NumberFormat = "h:mm"
                            wsTarget.Range("H18").Value = .Cells(rowNum, i).Value
                            Exit For
                        End If
                    Next i
                End If
            Next colNum
        Next rowNum
    End With
    wbShift.Close False


    ' ==== æ®‹æ¥­æ™‚é–“è¡¨ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠ ====
    Dim filePathZan As String
    filePathZan = Application.GetOpenFilename("Excelãƒ•ã‚¡ã‚¤ãƒ« (*.xlsx), *.xlsx", , "æ®‹æ¥­æ™‚é–“ç®¡ç†è¡¨ã‚’é¸æŠã—ã¦ãã ã•ã„")

    If filePathZan = "False" Then
        MsgBox "æ®‹æ¥­æ™‚é–“ç®¡ç†è¡¨ãŒé¸æŠã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚", vbExclamation
        Exit Sub
    End If

    Set wbZangyo = Workbooks.Open(filePathZan)
    With wbZangyo.Sheets(1)
        wsTarget.Range("H14").NumberFormat = "h:mm"
        wsTarget.Range("H14").Value = .Range("AL4").Value

        wsTarget.Range("H22").NumberFormat = "h:mm"
        wsTarget.Range("H22").Value = .Range("AO4").Value
    End With
    wbZangyo.Close False

    ' ==== ç¨¼åƒç‡è¨ˆç®— ====
    åˆè¨ˆå·¥æ•° = GetMinutes(Application.WorksheetFunction.Sum(wsTarget.Range("EP11:EP64")))
    ç·å‹¤å‹™æ™‚é–“ = GetMinutes(wsTarget.Range("H10").Value)

    If ç·å‹¤å‹™æ™‚é–“ > 0 Then
        ç¨¼åƒç‡ = åˆè¨ˆå·¥æ•° / ç·å‹¤å‹™æ™‚é–“
    Else
        ç¨¼åƒç‡ = 0
    End If

    msgText = "ğŸ“Š ç¨¼åƒç‡ = " & Format(ç¨¼åƒç‡, "0.0%") & vbCrLf & _
              "ãƒ»å·¥æ•°åˆè¨ˆï¼ˆEP11:EP64ï¼‰: " & Format(åˆè¨ˆå·¥æ•° / 60, "0.0") & " æ™‚é–“" & vbCrLf & _
              "ãƒ»ç·å‹¤å‹™æ™‚é–“ï¼ˆH10ï¼‰: " & Format(ç·å‹¤å‹™æ™‚é–“ / 60, "0.0") & " æ™‚é–“"

    MsgBox msgText, vbInformation, "âœ… ç¨¼åƒç‡ç¢ºèªå®Œäº†"

End Sub

Function GetMinutes(timeVal As Variant) As Double
    If IsDate(timeVal) Then
        GetMinutes = CDbl(timeVal) * 24 * 60
    Else
        GetMinutes = 0
    End If
End Function


Sub å·¥æ•°é›†è¨ˆ_è‡ªå‹•å‡¦ç†()

    On Error GoTo ERROR_HANDLER

    Dim å¹´ As String, æœˆ As String, yyyymm As String
    Dim checkResult As Boolean

    å¹´ = InputBox("å¹´ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š2025ï¼‰")
    æœˆ = InputBox("æœˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š01ï¼‰")

    If å¹´ = "" Or æœˆ = "" Then
        MsgBox "å¹´ã¨æœˆã®å…¥åŠ›ãŒå¿…è¦ã§ã™ã€‚", vbExclamation
        Exit Sub
    End If

    yyyymm = å¹´ & æœˆ

    ' Step0ï¼šäº‹å‰ã«å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒå…¨ã¦å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    checkResult = Check_RequiredFilesExist(yyyymm)
    If checkResult = False Then
        MsgBox "å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ã„ãšã‚Œã‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å‡¦ç†ã‚’ä¸­æ­¢ã—ã¾ã™ã€‚", vbCritical
        Exit Sub
    End If

    ' Step1ã€œ3ï¼šå®Ÿå‡¦ç†
    Call Import_AllSources(yyyymm, å¹´, æœˆ)
    Call Copy_WorkHours_Byå·¥æ•°ç•ªå·(yyyymm, å¹´, æœˆ)
    

    MsgBox "å…¨ã¦ã®å‡¦ç†ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼", vbInformation
    Exit Sub

ERROR_HANDLER:
    MsgBox "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š" & Err.Description, vbCritical
End Sub

Function Check_RequiredFilesExist(yyyymm As String) As Boolean

    Dim pathBase As String
    Dim file1 As String, file2 As String, file3 As String
    Dim result As Boolean

    pathBase = "\\bbwcfs.local\share4\SBM1\SharePrj\å¤§å®®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ³ã‚¿ãƒ¼é‹ç”¨ãƒ•ã‚©ãƒ«ãƒ€\06.æ—¥å ±\06.50 å®šæ™‚_å·¥æ•°é›†è¨ˆ\202504å·¥æ•°ãƒ«ãƒ¼ãƒ«æ”¹å®š\ãƒã‚¯ãƒ­ä¿®æ­£ä¸­\å·¥æ•°ãƒ‡ãƒ¼ã‚¿æå‡ºç”¨åŠ å·¥"

    file1 = Dir(pathBase & "\â‘ å·¥æ•°é›†è¨ˆ_å®šæ™‚ä½œæ¥­ãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆ_*" & yyyymm & "*.xlsx")
    file2 = Dir(pathBase & "\â‘¡å·¥æ•°é›†è¨ˆ_å®šæ™‚å¤–_*" & yyyymm & "*.xlsx")
    file3 = Dir(pathBase & "\â‘£å·¥æ•°é›†è¨ˆ_æ—¥å ±_*" & yyyymm & "*.xlsx")

    ' ä¸‰ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå…¨ã¦å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    If file1 <> "" And file2 <> "" And file3 <> "" Then
        Check_RequiredFilesExist = True
    Else
        Dim msg As String
        msg = "ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼š" & vbCrLf
        If file1 = "" Then msg = msg & "â‘ å·¥æ•°é›†è¨ˆ_å®šæ™‚ä½œæ¥­ãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆ_" & yyyymm & vbCrLf
        If file2 = "" Then msg = msg & "â‘¡å·¥æ•°é›†è¨ˆ_å®šæ™‚å¤–_" & yyyymm & vbCrLf
        If file3 = "" Then msg = msg & "â‘£å·¥æ•°é›†è¨ˆ_æ—¥å ±_" & yyyymm & vbCrLf
        MsgBox msg, vbExclamation, "ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèªã‚¨ãƒ©ãƒ¼"
        Check_RequiredFilesExist = False
    End If

End Function
