Sub 行マッピング_日別色判定貼付()

    Dim wsSrc As Worksheet, wsDest As Worksheet
    Dim 工数Map As Object
    Dim i As Integer, srcRow As Long
    Dim 工数番号 As String
    Dim destRow As Long
    Dim dayBaseCol As Long
    Dim colOffset As Long
    Dim 日勤列 As Long, 夜勤列 As Long
    Dim 日付判定セル As Range

    Set wsSrc = ThisWorkbook.Worksheets("0消し(最終)")
    Set wsDest = ThisWorkbook.Worksheets("工数取得-都度対応項目(時間)")
    Set 工数Map = CreateObject("Scripting.Dictionary")

    ' Step 1: 建立 工数番号 → 行号映射（从 I11:I64）
    For destRow = 11 To 64
        工数番号 = Trim(CStr(wsDest.Cells(destRow, "I").Value))
        If 工数番号 <> "" Then
            工数Map(工数番号) = destRow
        End If
    Next

    ' Step 2: 对于每一天（0~30）
    For i = 0 To 30

        ' 判断该日是平日 or 休日
        Set 日付判定セル = wsDest.Cells(11, 4 * i + 15) ' 第一天 = O列 = 列15

        If 日付判定セル.DisplayFormat.Interior.ColorIndex = xlNone Then
            ' 休日 → 从 R/S 开始（偏移2）
            colOffset = 2
        Else
            ' 平日 → 从 P/Q 开始（偏移0）
            colOffset = 0
        End If

        ' 计算该日应粘贴的起始列
        dayBaseCol = 4 * i + 15 + colOffset

        ' 从0消中读取每个工数的数据（E6:E52）
        For srcRow = 6 To 52
            工数番号 = Trim(CStr(wsSrc.Cells(srcRow, "E").Value))

            If 工数Map.exists(工数番号) Then
                destRow = 工数Map(工数番号)

                ' 来源列：F列=6 开始，每天2列
                日勤列 = 2 * i + 6
                夜勤列 = 2 * i + 7

                ' 粘贴日勤数据
                With wsDest.Cells(destRow, dayBaseCol)
                    .NumberFormat = "h:mm"
                    .Value = wsSrc.Cells(srcRow, 日勤列).Value
                End With

                ' 粘贴夜勤数据
                With wsDest.Cells(destRow, dayBaseCol + 1)
                    .NumberFormat = "h:mm"
                    .Value = wsSrc.Cells(srcRow, 夜勤列).Value
                End With

            End If
        Next srcRow

    Next i

    MsgBox "交差貼付完了！全工数番号・全日付データを処理しました。", vbInformation

End Sub


今回、③と④の工数自動処理ツールについて、今後の工数ルール変更と現場で挙がった運用上の課題に対応するため、以下の2点を中心に改修を行いました。

■① 工数ルール更新への対応（47行 → 54行）
今後④のシート側も含めて工数番号の上限が47行から54行へ拡張される予定があるため、それに合わせてツール側の行数設定を変更しました。

これにより、今後新たに追加される工数番号でも正しい位置に転記されるようになっています。
※今回の検証では2025年3月分の日報を使用していますが、当時は旧ルールのままだったため、3月4日と6日の工数番号（39 → 46）を手動修正した上で動作確認を行っています。
試用時は、この2日間の内容が正しく反映されているかを特に確認してください。

■② 実運用での指摘事項への対応
現場からのフィードバックをもとに、以下のような細かい改善を追加しています：

夜勤の判定時間を従来の「17:00以降」から「17:30以降」に変更

日報や作業日入力ミスなど、現場で起こりやすい入力不備への対応として、エラー時にポップアップで警告を出すように設定
　例）工数番号未入力／時間帯が曖昧で日勤・夜勤の判断ができない（14:12〜14:17 など）

また、エラー発生後の再転記処理についても改修しています。
従来は同じ日の日報を再度転記すると、タイトルや④の件数が重複することがありましたが、今回の修正により、エラー修正後にもう一度「日報転記」ボタンを押せば、上書きされるだけでデータが重複しないようになりました。

【不明】と表示された項目については、OPが日報内容を確認し、手動で「日勤」または「夜勤」に修正してください。
その際、④の項目も忘れずに合わせて修正をお願いします。

■ 注意事項（今回の改修ポイントを踏まえて）
● 工数ルールの変更対応（47行 → 54行）
今後、④の工数ルールが54行に拡張される方針に伴い、本ツールも新しい工数番号に対応しています。
新しい番号も自動的に正しい位置へ転記されます。

● エラー検出機能の強化
以下のような場合、エラーとしてポップアップで通知される仕様になっています。

工数番号の未入力行がある

時間帯の記載が曖昧で日勤／夜勤の判定ができない（例：14:17〜14:22）

● エラー後の再転記について
エラー修正後にもう一度「日報転記」ボタンを押しても、データは正しく上書きされ、重複は発生しません。
安心して再転記を行ってください。

● 【不明】と表示された箇所の対応
日勤／夜勤の自動判定ができず【不明】となった場合は、日報内容を確認の上、手動で修正してください。
※この際、④の内容も忘れずに合わせて修正を行ってください。
